{% extends 'base.html' %}

{% block title %}Смена пароля пользователей - CRM Ткани{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-key"></i> Смена пароля пользователей</h1>
    <a href="{% url 'finances:system_settings' %}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left"></i> К настройкам
    </a>
</div>



<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people"></i> Выберите пользователя</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Кнопка для изменения пароля администратора -->
                    <div class="col-12 col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 border-danger">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="bi bi-shield-lock text-danger" style="font-size: 2rem;"></i>
                                </div>
                                <h6 class="card-title">{{ request.user.username }}</h6>
                                <p class="card-text">
                                    <span class="badge bg-danger">
                                        Администратор
                                    </span>
                                </p>
                                <a href="{% url 'finances:change_admin_password_page' %}" 
                                   class="btn btn-danger w-100">
                                    <i class="bi bi-shield-key"></i> Изменить свой пароль
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Список остальных пользователей -->
                    {% if users %}
                        {% for user in users %}
                            <div class="col-12 col-md-6 col-lg-4 mb-3">
                                <div class="card h-100 border-primary">
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            {% if user.role_code == 'admin' %}
                                                <i class="bi bi-shield-fill text-danger" style="font-size: 2rem;"></i>
                                            {% elif user.role_code == 'accountant' %}
                                                <i class="bi bi-calculator-fill text-success" style="font-size: 2rem;"></i>
                                            {% elif user.role_code == 'warehouse' %}
                                                <i class="bi bi-box-seam-fill text-warning" style="font-size: 2rem;"></i>
                                            {% endif %}
                                        </div>
                                        <h6 class="card-title">{{ user.username }}</h6>
                                        <p class="card-text">
                                            <span class="badge 
                                                {% if user.role_code == 'admin' %}bg-danger
                                                {% elif user.role_code == 'accountant' %}bg-success
                                                {% elif user.role_code == 'warehouse' %}bg-warning text-dark
                                                {% endif %}">
                                                {{ user.role }}
                                            </span>
                                        </p>
                                        <button type="button" 
                                                class="btn btn-primary w-100"
                                                onclick="changeUserPassword({{ user.id }}, '{{ user.username }}')">
                                            <i class="bi bi-key"></i> Сменить пароль
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
                
                {% if not users %}
                    <div class="text-center py-4">
                        <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3">Другие пользователи не найдены</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для смены пароля -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Смена пароля</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    {% csrf_token %}
                    <input type="hidden" id="userId" name="user_id">
                    
                    <div class="mb-3">
                        <label for="oldPassword" class="form-label">Текущий пароль</label>
                        <input type="password" class="form-control" id="oldPassword" name="old_password" required>
                        <div class="form-text">Введите текущий пароль пользователя</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Новый пароль</label>
                        <input type="password" class="form-control" id="newPassword" name="new_password" required>
                        <div class="form-text">Минимум 4 символа</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Подтвердите пароль</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                        <div class="form-text">Повторите новый пароль</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="savePassword()">
                    <i class="bi bi-check"></i> Сохранить
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function changeUserPassword(userId, username) {
    document.getElementById('userId').value = userId;
    document.getElementById('modalTitle').textContent = `Смена пароля: ${username}`;
    
    // Очищаем форму
    document.getElementById('changePasswordForm').reset();
    
    // Показываем модальное окно
    new bootstrap.Modal(document.getElementById('changePasswordModal')).show();
}

function savePassword() {
    const form = document.getElementById('changePasswordForm');
    const formData = new FormData(form);
    
    const oldPassword = formData.get('old_password');
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    const userId = formData.get('user_id');
    
    // Валидация
    if (!oldPassword || !newPassword || !confirmPassword) {
        alert('Пожалуйста, заполните все поля');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert('Новые пароли не совпадают!');
        return;
    }
    
    if (newPassword.length < 4) {
        alert('Пароль должен содержать минимум 4 символа');
        return;
    }
    
    // Отправляем запрос
    fetch('/finances/change-user-password/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `user_id=${userId}&old_password=${encodeURIComponent(oldPassword)}&new_password=${encodeURIComponent(newPassword)}&confirm_password=${encodeURIComponent(confirmPassword)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Пароль успешно изменен!');
            bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при смене пароля');
    });
}
</script>
{% endblock %} 