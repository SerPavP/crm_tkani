{% extends 'base.html' %}
{% load deal_filters %}
{% load math_filters %}

{% block title %}Финансовая аналитика - CRM Ткани{% endblock %}

<style>
.kpi-card {
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.period-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.period-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
}

.period-card.active {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.trend-up {
    color: #28a745;
}

.trend-down {
    color: #dc3545;
}

.nav-tabs .nav-link {
    border: 2px solid #dee2e6;
    color: #495057;
    background-color: #ffffff;
    margin: 0 0.25rem;
    border-radius: 8px;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
}

.nav-tabs .nav-link:hover:not(.active) {
    border-color: #007bff;
    color: #007bff;
    background-color: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.nav-tabs .nav-link.active {
    background-color: #007bff;
    color: white;
    border: 2px solid #007bff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    transform: translateY(-2px);
}

/* Стили для мобильных устройств */
@media (max-width: 768px) {
    /* Основные навигационные табы */
    .nav-tabs .nav-link {
        font-size: 1rem;
        padding: 1rem 0.75rem;
        margin: 0.25rem 0.1rem;
        text-align: center;
        min-height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        border-radius: 12px !important;
        border: 3px solid #dee2e6 !important;
        background-color: #ffffff !important;
        color: #495057 !important;
        font-weight: 600 !important;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15) !important;
    }
    
    .nav-tabs .nav-link:hover:not(.active) {
        border-color: #007bff !important;
        color: #007bff !important;
        background-color: #f8f9fa !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 12px rgba(0,0,0,0.2) !important;
    }
    
    .nav-tabs .nav-link.active {
        font-weight: bold !important;
        background-color: #007bff !important;
        color: white !important;
        border: 3px solid #007bff !important;
        box-shadow: 0 6px 16px rgba(0,123,255,0.4) !important;
        transform: translateY(-3px) scale(1.02) !important;
    }
    
    .nav-tabs .nav-link i {
        font-size: 1.3rem;
        margin-bottom: 0.35rem;
        display: block;
    }
    
    /* KPI карточки */
    .kpi-card {
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }
    
    .kpi-card .card-title {
        font-size: 0.85rem;
    }
    
    .kpi-card h4 {
        font-size: 1.1rem;
    }
    
    /* Графики */
    .row.mb-4 {
        margin-bottom: 2rem !important;
    }
    
    .card-header h6 {
        font-size: 0.9rem;
        text-align: center;
    }
    
    /* Кнопки переключения Топ 20 */
    .btn-group .btn {
        font-size: 0.85rem;
        padding: 0.75rem 0.5rem;
        flex-direction: column;
        min-height: 60px;
    }
    
    .btn-group .btn i {
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
    }
    
    /* Таблицы */
    .table {
        font-size: 0.8rem;
    }
    
    .table th, .table td {
        padding: 0.5rem 0.25rem;
        vertical-align: middle;
    }
    
    .table-responsive {
        border-radius: 8px;
    }
    
    /* Формы фильтров */
    .form-control, .btn {
        font-size: 0.9rem;
    }
    
    .btn-group.btn-sm .btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
    }
    
    /* Периодные карточки */
    .period-card {
        margin-bottom: 1rem;
        min-height: 80px;
    }
    
    .period-card .card-body {
        padding: 1rem 0.75rem;
    }
    
    /* Скрытие элементов на мобильных */
    .d-md-block {
        display: none !important;
    }
    
    /* Улучшение читаемости текста */
    h1 {
        font-size: 1.5rem;
    }
    
    h5 {
        font-size: 1.1rem;
    }
    
    /* Отступы для контейнера */
    .container-fluid {
        padding-left: 10px;
        padding-right: 10px;
    }
}

/* Стили для очень маленьких экранов (телефоны) */
@media (max-width: 576px) {
    /* Заголовок страницы */
    .d-flex.justify-content-between.align-items-center {
        flex-direction: column;
        align-items: stretch !important;
        gap: 1rem;
    }
    
    .d-flex.justify-content-between.align-items-center h1 {
        text-align: center;
        font-size: 1.3rem;
        margin-bottom: 0;
    }
    
    .d-flex.justify-content-between.align-items-center > div {
        text-align: center;
    }
    
    /* Основные табы в одну колонку */
    .nav-tabs {
        flex-direction: column;
        background-color: transparent;
        border: none;
        padding: 0;
    }
    
    .nav-tabs .nav-item {
        width: 100%;
        margin-bottom: 0.75rem;
    }
    
    .nav-tabs .nav-link {
        width: 100%;
        border-radius: 12px !important;
        border: 4px solid #dee2e6 !important;
        margin: 0 0 0.75rem 0 !important;
        min-height: 80px !important;
        font-size: 1.1rem !important;
        padding: 1.25rem 1rem !important;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }
    
    .nav-tabs .nav-link:hover:not(.active) {
        border: 4px solid #007bff !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        transform: translateY(-3px) !important;
        box-shadow: 0 8px 20px rgba(0,0,0,0.25) !important;
    }
    
    .nav-tabs .nav-link.active {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        border: 4px solid #0056b3 !important;
        box-shadow: 0 8px 24px rgba(0,123,255,0.5) !important;
        transform: translateY(-4px) scale(1.03) !important;
    }
    
    .nav-tabs .nav-link i {
        font-size: 1.5rem !important;
        margin-bottom: 0.5rem !important;
    }
    
    /* KPI карточки в одну колонку */
    .row .col-md-3 {
        margin-bottom: 1rem;
    }
    
    /* Графики */
    .card-header h6 {
        font-size: 0.8rem;
        line-height: 1.2;
    }
    
    /* Кнопки переключения периодов */
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        border-radius: 6px !important;
        margin-bottom: 0.25rem;
        width: 100%;
    }
    
    /* Формы */
    .row.g-3 > div {
        margin-bottom: 1rem;
    }
    
    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    /* Таблицы - скролл по горизонтали */
    .table-responsive {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .table {
        min-width: 500px;
        margin-bottom: 0;
    }
    
    /* Кнопки действий в таблицах */
    .btn-sm {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Скрытие некоторых колонок в таблицах на очень маленьких экранах */
    .table th:nth-child(n+4),
    .table td:nth-child(n+4) {
        display: none;
    }
    
    /* Показываем только основные колонки */
    .table th:nth-child(1),
    .table th:nth-child(2),
    .table th:nth-child(3),
    .table td:nth-child(1),
    .table td:nth-child(2),
    .table td:nth-child(3) {
        display: table-cell;
    }
}

/* Стили для кнопок переключения Топ 20 */
.btn-group .btn {
    flex: 1;
    font-weight: 500;
    padding: 0.75rem 1rem;
    border-radius: 0;
}

.btn-group .btn:first-child {
    border-top-left-radius: 0.375rem;
    border-bottom-left-radius: 0.375rem;
}

.btn-group .btn:last-child {
    border-top-right-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
}

.btn-group .btn.active {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}

.btn-group .btn:hover:not(.active) {
    background-color: #f8f9fa;
    border-color: #007bff;
    color: #007bff;
}

/* Улучшение touch-интерфейса */
@media (pointer: coarse) {
    /* Увеличиваем размер кликабельных элементов для touch */
    .btn, .nav-link, .clickable-row {
        min-height: 44px;
        min-width: 44px;
    }
    
    .period-card {
        min-height: 100px;
    }
    
    /* Улучшаем hover для touch-устройств */
    .btn:active, .nav-link:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
    }
    
    .period-card:active {
        transform: scale(0.98);
    }
}

/* Общие улучшения для мобильной навигации */
.mobile-friendly {
    -webkit-tap-highlight-color: rgba(0,0,0,0.1);
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* Дополнительное выделение для лучшей видимости */
.nav-tabs {
    background-color: #f8f9fa;
    padding: 0.75rem;
    border-radius: 10px;
    margin-bottom: 1rem;
}

/* Анимация для привлечения внимания к табам */
@keyframes subtle-pulse {
    0% { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    50% { box-shadow: 0 4px 8px rgba(0,123,255,0.2); }
    100% { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
}

.nav-tabs .nav-link:not(.active):hover {
    animation: subtle-pulse 2s ease-in-out infinite;
}

/* Дополнительная визуальная индикация */
.nav-tabs .nav-link::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, #007bff, #0056b3, #007bff);
    border-radius: inherit;
    z-index: -1;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.nav-tabs .nav-link.active::before {
    opacity: 1;
}
</style>

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-graph-up"></i> Финансовая аналитика</h1>
    <div>
        <a href="{% url 'finances:system_settings' %}" class="btn btn-outline-secondary">
            <i class="bi bi-gear"></i> Настройки
        </a>
        <a href="{% url 'finances:set_fabric_cost_price' %}" class="btn btn-outline-info">
            <i class="bi bi-currency-exchange"></i> Себестоимость
        </a>
    </div>
</div>

<!-- KPI-блоки -->
<div class="row mb-3">
    <div class="col-12">
        <h4 class="text-muted"><i class="bi bi-graph-up"></i> Статистика за этот месяц</h4>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card kpi-card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Общая продажа</h6>
                        <h4 class="mb-0">{{ current_period_revenue|format_price }} ₸</h4>
                        <small class="trend-up">
                            {% if revenue_trend > 0 %}↑{% else %}↓{% endif %} 
                            {% if revenue_trend < 0 %}{{ revenue_trend|mul:-1|floatformat:2 }}{% else %}{{ revenue_trend|floatformat:2 }}{% endif %}% к пред. пер.
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-calendar-month display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Общая выручка</h6>
                        <h4 class="mb-0">{{ current_period_profit|format_price }} ₸</h4>
                        <small class="trend-up">
                            {% if profit_trend > 0 %}↑{% else %}↓{% endif %} 
                            {% if profit_trend < 0 %}{{ profit_trend|mul:-1|floatformat:2 }}{% else %}{{ profit_trend|floatformat:2 }}{% endif %}% к пред. пер.
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-graph-up-arrow display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Рентабельность</h6>
                        <h4 class="mb-0">{{ current_period_margin|floatformat:1 }}%</h4>
                        <small class="{% if margin_trend > 0 %}trend-up{% else %}trend-down{% endif %}">
                            {% if margin_trend > 0 %}↑{% else %}↓{% endif %} 
                            {% if margin_trend < 0 %}{{ margin_trend|mul:-1|floatformat:2 }}{% else %}{{ margin_trend|floatformat:2 }}{% endif %}% к пред. пер.
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-percent display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Средний чек</h6>
                        <h4 class="mb-0">{{ current_period_avg_check|format_price }} ₸</h4>
                        <small class="trend-up">
                            {% if avg_check_trend > 0 %}↑{% else %}↓{% endif %} 
                            {% if avg_check_trend < 0 %}{{ avg_check_trend|mul:-1|floatformat:2 }}{% else %}{{ avg_check_trend|floatformat:2 }}{% endif %}% к пред. пер.
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-receipt display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card kpi-card text-white bg-secondary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Количество сделок</h6>
                        <h4 class="mb-0">{{ current_period_deals_count }} сделок</h4>
                        <small class="trend-up">
                            {% if deals_count_trend > 0 %}↑{% else %}↓{% endif %} 
                            {% if deals_count_trend < 0 %}{{ deals_count_trend|mul:-1 }}{% else %}{{ deals_count_trend }}{% endif %} сделок
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-cart-check display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card text-white bg-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Топ-ткань месяца</h6>
                        <h4 class="mb-0">{% if top_fabric_month %}{{ top_fabric_month.name }}{% else %}Нет данных{% endif %}</h4>
                        <small>{% if top_fabric_month %}{{ top_fabric_month.revenue|format_price }} ₸{% else %}0 ₸{% endif %}</small>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-palette display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card text-white bg-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Рулоны за месяц</h6>
                        <h4 class="mb-0">{{ current_period_rolls_count }} шт.</h4>
                        <small class="trend-up">
                            {% if rolls_count_trend > 0 %}↑{% else %}↓{% endif %} 
                            {% if rolls_count_trend < 0 %}{{ rolls_count_trend|mul:-1 }}{% else %}{{ rolls_count_trend }}{% endif %} шт.
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-box display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Финансовые графики -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-currency-exchange"></i> Заработок за этот месяц (каждые 3 дня)</h6>
            </div>
            <div class="card-body">
                <canvas id="weeklyRevenueChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-bar-chart-fill"></i> Топ 10 популярных тканей</h6>
            </div>
            <div class="card-body">
                <canvas id="topFabricsChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Количество сделок за месяц (каждые 3 дня)</h6>
            </div>
            <div class="card-body">
                <canvas id="weeklyDealsChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-cash-stack"></i> Средний чек за месяц</h6>
            </div>
            <div class="card-body">
                <canvas id="avgCheckChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Переключатель режимов -->
<div class="card mb-4">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="analyticsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active btn-lg px-4 py-2 fw-bold mobile-friendly" id="quick-tab" data-bs-toggle="tab" data-bs-target="#quick" type="button" role="tab">
                    <i class="bi bi-lightning"></i> Быстрая информация
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link btn-lg px-4 py-2 fw-bold mobile-friendly" id="periods-tab" data-bs-toggle="tab" data-bs-target="#periods" type="button" role="tab">
                    <i class="bi bi-calendar-range"></i> По периодам
                </button>
            </li>
            {% if user.userprofile.role == 'admin' %}
            <li class="nav-item" role="presentation">
                <button class="nav-link btn-lg px-4 py-2 fw-bold mobile-friendly" id="top20-tab" data-bs-toggle="tab" data-bs-target="#top20" type="button" role="tab">
                    <i class="bi bi-trophy"></i> Топ 20
                </button>
            </li>
            {% endif %}
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="analyticsTabContent">
            <!-- Быстрая информация -->
            <div class="tab-pane fade show active" id="quick" role="tabpanel">
                <!-- Интерактивные карточки периодов -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card period-card mobile-friendly" onclick="showPeriodDetails('today')">
                            <div class="card-body text-center">
                                <h5>Сегодня</h5>
                                <h3 class="text-primary">{{ today_revenue|format_price }} ₸</h3>
                                <p class="text-muted">{{ today_deals_count }} сделок</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card period-card mobile-friendly" onclick="showPeriodDetails('week')">
                            <div class="card-body text-center">
                                <h5>Неделя</h5>
                                <h3 class="text-success">{{ week_revenue|format_price }} ₸</h3>
                                <p class="text-muted">{{ week_deals_count }} сделок</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card period-card mobile-friendly" onclick="showPeriodDetails('month')">
                            <div class="card-body text-center">
                                <h5>Месяц</h5>
                                <h3 class="text-info">{{ month_revenue|format_price }} ₸</h3>
                                <p class="text-muted">{{ month_deals_count }} сделок</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card period-card mobile-friendly" onclick="showPeriodDetails('quarter')">
                            <div class="card-body text-center">
                                <h5>Квартал</h5>
                                <h3 class="text-warning">{{ quarter_revenue|format_price }} ₸</h3>
                                <p class="text-muted">{{ quarter_deals_count }} сделок</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Дополнительная информация -->
                <div class="row">
                    <!-- Финансовые показатели -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Финансовые показатели</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-12 mb-3">
                                        <h5 class="text-success">{{ current_period_profit|format_price }} ₸</h5>
                                        <small class="text-muted">Общая прибыль (30 дней)</small>
                                        </div>
                                    <div class="col-6">
                                        <h6 class="text-info">{{ current_period_margin|floatformat:1 }}%</h6>
                                        <small class="text-muted">Рентабельность</small>
                                    </div>
                                    <div class="col-6">
                                        <h6 class="text-warning">{{ current_period_avg_check|format_price }} ₸</h6>
                                        <small class="text-muted">Средний чек</small>
                                        </div>
                                    </div>
                                        </div>
                                    </div>
                                </div>

                    <!-- Складские показатели -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-box-seam"></i> Складские показатели</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-12 mb-3">
                                        <h5 class="text-primary">{{ current_period_rolls_count }}</h5>
                                        <small class="text-muted">Рулонов использовано (30 дней)</small>
                                    </div>
                                    <div class="col-6">
                                        <h6 class="text-secondary">{{ turnover_days|floatformat:0 }}</h6>
                                        <small class="text-muted">Дней оборота</small>
                                    </div>
                                    <div class="col-6">
                                        <h6 class="text-info">{{ top_fabric_month.name|default:"—" }}</h6>
                                        <small class="text-muted">Топ ткань месяца</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Тренды и сравнения -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-trending-up"></i> Тренды (vs прошлый период)</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6 mb-2">
                                        <span class="{% if revenue_trend >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            <i class="bi {% if revenue_trend >= 0 %}bi-arrow-up{% else %}bi-arrow-down{% endif %}"></i>
                                            {{ revenue_trend|floatformat:1 }}%
                                        </span>
                                        <br><small class="text-muted">Выручка</small>
                                        </div>
                                    <div class="col-6 mb-2">
                                        <span class="{% if profit_trend >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            <i class="bi {% if profit_trend >= 0 %}bi-arrow-up{% else %}bi-arrow-down{% endif %}"></i>
                                            {{ profit_trend|floatformat:1 }}%
                                        </span>
                                        <br><small class="text-muted">Прибыль</small>
                                    </div>
                                    <div class="col-6">
                                        <span class="{% if deals_count_trend >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            <i class="bi {% if deals_count_trend >= 0 %}bi-arrow-up{% else %}bi-arrow-down{% endif %}"></i>
                                            {{ deals_count_trend|floatformat:1 }}%
                                        </span>
                                        <br><small class="text-muted">Количество сделок</small>
                                        </div>
                                    <div class="col-6">
                                        <span class="{% if avg_check_trend >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            <i class="bi {% if avg_check_trend >= 0 %}bi-arrow-up{% else %}bi-arrow-down{% endif %}"></i>
                                            {{ avg_check_trend|floatformat:1 }}%
                                        </span>
                                        <br><small class="text-muted">Средний чек</small>
                                    </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                <!-- Дополнительная статистика -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-calendar-check"></i> Общая статистика</h6>
                    </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <h6 class="text-primary">{{ current_period_deals_count }}</h6>
                                        <small class="text-muted">Всего сделок</small>
                                    </div>
                                    <div class="col-4">
                                        <h6 class="text-success">{{ current_period_revenue|format_price }} ₸</h6>
                                        <small class="text-muted">Общая выручка</small>
                                    </div>
                                    <div class="col-4">
                                        <h6 class="text-warning">{{ turnover_days|floatformat:0 }} дн.</h6>
                                        <small class="text-muted">Оборачиваемость</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>

            <!-- По периодам -->
            <div class="tab-pane fade" id="periods" role="tabpanel">
                <!-- Фильтры периода -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form method="get" class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">От:</label>
                                <input type="date" name="date_from" class="form-control" value="{{ date_from|date:'Y-m-d' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">До:</label>
                                <input type="date" name="date_to" class="form-control" value="{{ date_to|date:'Y-m-d' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Быстрые периоды:</label>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm {% if not request.GET.date_from and not request.GET.date_to or request.GET.date_from == today_iso and request.GET.date_to == today_iso %}active{% endif %}" onclick="setQuickPeriod('today', this)">Сегодня</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm {% if request.GET.date_from == week_start_iso and request.GET.date_to == today_iso %}active{% endif %}" onclick="setQuickPeriod('week', this)">Неделя</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm {% if request.GET.date_from == month_start_iso and request.GET.date_to == today_iso %}active{% endif %}" onclick="setQuickPeriod('month', this)">Месяц</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm {% if request.GET.date_from == quarter_start_iso and request.GET.date_to == today_iso %}active{% endif %}" onclick="setQuickPeriod('quarter', this)">Квартал</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm {% if request.GET.date_from == year_start_iso and request.GET.date_to == today_iso %}active{% endif %}" onclick="setQuickPeriod('year', this)">Год</button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">Применить</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card mb-4" id="summary-card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <strong>Период:</strong><br>
                                <span id="summary-date-range">{{ date_from|date:"d.m.Y" }} - {{ date_to|date:"d.m.Y" }}</span>
                            </div>
                            <div class="col-md-2">
                                <strong>Общие продажи:</strong><br>
                                <span id="summary-revenue">{{ period_revenue|format_price }} ₸</span>
                            </div>
                            <div class="col-md-2">
                                <strong>Общая выручка:</strong><br>
                                <span id="summary-profit">{{ period_profit|format_price }} ₸</span>
                            </div>
                            <div class="col-md-2">
                                <strong>Рентабельность:</strong><br>
                                <span id="summary-margin">{{ period_margin|floatformat:1 }}%</span>
                            </div>
                            <div class="col-md-2">
                                <strong>Количество сделок:</strong><br>
                                <span id="summary-deals-count">{{ period_deals_count }}</span>
                            </div>
                            <div class="col-md-2">
                                <strong>Средний чек:</strong><br>
                                <span id="summary-avg-check">{{ period_avg_check|format_price }} ₸</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Таблица сделок -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Сделки за период</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>№ сделки</th>
                                        <th>Клиент</th>
                                        <th>Статус</th>
                                        <th>Сумма заказа</th>
                                        <th>Прибыль</th>
                                        <th>Рентабельность</th>
                                        <th>Позиций</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="deals-table-body">
                                    {% for deal in period_deals %}
                                    <tr class="clickable-row" data-href="{% url 'deals:deal_detail' deal.id %}">
                                        <td>{{ deal.created_at|date:"d.m.Y" }}</td>
                                        <td><code>{{ deal.deal_number|slice:":11" }}{% if deal.deal_number|length > 11 %}...{% endif %}</code></td>
                                        <td>{{ deal.client.nickname }}</td>
                                        <td>
                                            {% if deal.status == 'pending_payment' %}
                                                <span class="badge bg-warning">Ожидает оплаты</span>
                                            {% elif deal.status == 'paid' %}
                                                <span class="badge bg-success">Оплачен</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ deal.get_status_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td><strong>{{ deal.total_amount|format_price }} ₸</strong></td>
                                        <td class="text-success"><strong>{{ deal.total_profit|format_price }} ₸</strong></td>
                                        <td>
                                            {% if deal.total_amount > 0 %}
                                                {{ deal.total_profit|mul:100|div:deal.total_amount|floatformat:1 }}%
                                            {% else %}
                                                0%
                                            {% endif %}
                                        </td>
                                        <td>{{ deal.dealitem_set.count }}</td>
                                        <td>
                                            <a href="{% url 'deals:deal_detail' deal.id %}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> Детали
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



            <!-- Топ 20 -->
            {% if user.userprofile.role == 'admin' %}
            <div class="tab-pane fade" id="top20" role="tabpanel">
                <!-- Переключатель между клиентами и тканями -->
                <div class="card mb-4">
    <div class="card-header">
                        <div class="btn-group w-100" role="group" aria-label="Top 20 sections">
                            <button type="button" class="btn btn-outline-primary active mobile-friendly" id="clientsTab" onclick="showTop20Tab('clients')">
                                <i class="bi bi-people"></i> Топ 20 клиентов
                            </button>
                            <button type="button" class="btn btn-outline-primary mobile-friendly" id="fabricsTab" onclick="showTop20Tab('fabrics')">
                                <i class="bi bi-palette"></i> Топ 20 тканей
                            </button>
    </div>
                    </div>
                </div>

                <!-- Контент клиентов -->
                <div id="clientsContent" class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" data-bs-toggle="tab" href="#top20-clients-revenue">По общей выручке</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#top20-clients-count">По заказам</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#top20-clients-profit">По выручке</a>
                                    </li>
                </ul>
            </div>
                            <div class="card-body">
                                <div class="tab-content">
                                    <!-- По выручке -->
                                    <div class="tab-pane fade show active" id="top20-clients-revenue">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Клиент</th>
                                                        <th>Общая выручка</th>
                                                        <th>Заказов</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for client_stat in top_20_clients_by_revenue %}
                                                    <tr class="clickable-row" data-href="{% url 'clients:client_detail' client_stat.client.id %}" style="cursor: pointer;">
                                                        <td>{{ forloop.counter }}</td>
                                                        <td>
                                                            <strong>{{ client_stat.client.nickname }}</strong>
                                                            {% if client_stat.client.phone %}
                                                                <br><small class="text-muted">{{ client_stat.client.phone }}</small>
                                                            {% endif %}
                                                        </td>
                                                        <td><strong>{{ client_stat.total_revenue|format_price }} ₸</strong></td>
                                                        <td><span class="badge bg-primary">{{ client_stat.total_deals }}</span></td>
                                                    </tr>
                                                    {% empty %}
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">Нет данных</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- По количеству заказов -->
                                    <div class="tab-pane fade" id="top20-clients-count">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Клиент</th>
                                                        <th>Количество заказов</th>
                                                        <th>Средний чек</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for client_stat in top_20_clients_by_count %}
                                                    <tr class="clickable-row" data-href="{% url 'clients:client_detail' client_stat.client.id %}" style="cursor: pointer;">
                                                        <td>{{ forloop.counter }}</td>
                                                        <td>
                                                            <strong>{{ client_stat.client.nickname }}</strong>
                                                            {% if client_stat.client.phone %}
                                                                <br><small class="text-muted">{{ client_stat.client.phone }}</small>
                                                            {% endif %}
                                                        </td>
                                                        <td><span class="badge bg-primary">{{ client_stat.total_deals }}</span></td>
                                                        <td>{{ client_stat.avg_check|format_price }} ₸</td>
                                                    </tr>
                                                    {% empty %}
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">Нет данных</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- По выручке -->
                                    <div class="tab-pane fade" id="top20-clients-profit">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Клиент</th>
                                                        <th>Прибыль</th>
                                                        <th>Рентабельность</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for client_stat in top_20_clients_by_profit %}
                                                    <tr class="clickable-row" data-href="{% url 'clients:client_detail' client_stat.client.id %}" style="cursor: pointer;">
                                                        <td>{{ forloop.counter }}</td>
                                                        <td>
                                                            <strong>{{ client_stat.client.nickname }}</strong>
                                                            {% if client_stat.client.phone %}
                                                                <br><small class="text-muted">{{ client_stat.client.phone }}</small>
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-success"><strong>{{ client_stat.total_profit|format_price }} ₸</strong></td>
                                                        <td>{{ client_stat.margin|floatformat:1 }}%</td>
                                                    </tr>
                                                    {% empty %}
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">Нет данных</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Контент тканей (скрыт по умолчанию) -->
                <div id="fabricsContent" class="row" style="display: none;">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" data-bs-toggle="tab" href="#top20-fabrics-orders">По заказам</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#top20-fabrics-meters">По метрам</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#top20-fabrics-profit">По выручке</a>
                                    </li>
                </ul>
            </div>
                            <div class="card-body">
                                <div class="tab-content">
                                    <!-- По количеству заказов -->
                                    <div class="tab-pane fade show active" id="top20-fabrics-orders">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Ткань</th>
                                                        <th>Заказов</th>
                                                        <th>Частота</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for fabric_stat in top_20_fabrics_by_orders %}
                                                    <tr class="clickable-row" data-href="{% url 'fabrics:fabric_detail' fabric_stat.fabric.id %}" style="cursor: pointer;">
                                                        <td>{{ forloop.counter }}</td>
                                                        <td>
                                                            <strong>{{ fabric_stat.fabric.name }}</strong>
                                                            <br><small class="text-muted">{{ fabric_stat.fabric.category.name }}</small>
                                                        </td>
                                                        <td><span class="badge bg-info">{{ fabric_stat.total_orders }}</span></td>
                                                        <td>{{ fabric_stat.order_frequency }}</td>
                                                    </tr>
                                                    {% empty %}
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">Нет данных</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- По метрам -->
                                    <div class="tab-pane fade" id="top20-fabrics-meters">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Ткань</th>
                                                        <th>Метров</th>
                                                        <th>Заказов</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for fabric_stat in top_20_fabrics_by_meters %}
                                                    <tr class="clickable-row" data-href="{% url 'fabrics:fabric_detail' fabric_stat.fabric.id %}" style="cursor: pointer;">
                                                        <td>{{ forloop.counter }}</td>
                                                        <td>
                                                            <strong>{{ fabric_stat.fabric.name }}</strong>
                                                            <br><small class="text-muted">{{ fabric_stat.fabric.category.name }}</small>
                                                        </td>
                                                        <td><span class="badge bg-secondary">{{ fabric_stat.total_meters|floatformat:1 }}м</span></td>
                                                        <td><span class="badge bg-info">{{ fabric_stat.total_orders }}</span></td>
                                                    </tr>
                                                    {% empty %}
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">Нет данных</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- По выручке -->
                                    <div class="tab-pane fade" id="top20-fabrics-profit">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Ткань</th>
                                                        <th>Прибыль</th>
                                                        <th>Выручка</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for fabric_stat in top_20_fabrics_by_profit %}
                                                    <tr class="clickable-row" data-href="{% url 'fabrics:fabric_detail' fabric_stat.fabric.id %}" style="cursor: pointer;">
                                                        <td>{{ forloop.counter }}</td>
                                                        <td>
                                                            <strong>{{ fabric_stat.fabric.name }}</strong>
                                                            <br><small class="text-muted">{{ fabric_stat.fabric.category.name }}</small>
                                                        </td>
                                                        <td class="text-success"><strong>{{ fabric_stat.total_profit|format_price }} ₸</strong></td>
                                                        <td><strong>{{ fabric_stat.total_revenue|format_price }} ₸</strong></td>
                                                    </tr>
                                                    {% empty %}
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">Нет данных</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function showPeriodDetails(period) {
    // Здесь можно добавить модальное окно с детализацией
    console.log('Показать детали для периода:', period);
}

function setQuickPeriod(period, button = null) {
    const today = new Date();
    let dateFrom, dateTo;
    
    // Remove active class from all quick period buttons
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });

    switch(period) {
        case 'today':
            dateFrom = today.toISOString().split('T')[0];
            dateTo = today.toISOString().split('T')[0];
            break;
        case 'week':
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            dateFrom = weekAgo.toISOString().split('T')[0];
            dateTo = today.toISOString().split('T')[0];
            break;
        case 'month':
            const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            dateFrom = monthAgo.toISOString().split('T')[0];
            dateTo = today.toISOString().split('T')[0];
            break;
        case 'quarter':
            const quarterAgo = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
            dateFrom = quarterAgo.toISOString().split('T')[0];
            dateTo = today.toISOString().split('T')[0];
            break;
        case 'year':
            const yearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
            dateFrom = yearAgo.toISOString().split('T')[0];
            dateTo = today.toISOString().split('T')[0];
            break;
    }
    
    document.querySelector('input[name="date_from"]').value = dateFrom;
    document.querySelector('input[name="date_to"]').value = dateTo;
    updatePeriodData(dateFrom, dateTo); // Вызываем новую функцию для обновления данных

    // Add active class to the clicked button
    if (button) {
        button.classList.add('active');
    } else {
        // Fallback for initial load if not triggered by button click
        const allButtons = document.querySelectorAll('.btn-group .btn');
        allButtons.forEach(btn => {
            if (btn.textContent.includes(period === 'today' ? 'Сегодня' : 
                                          period === 'week' ? 'Неделя' : 
                                          period === 'month' ? 'Месяц' : 
                                          period === 'quarter' ? 'Квартал' : 
                                          'Год')) {
                btn.classList.add('active');
            }
        });
    }
}

function updatePeriodData(dateFrom, dateTo) {
    const url = `{% url 'finances:get_period_data' %}?date_from=${dateFrom}&date_to=${dateTo}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Обновляем сводную информацию
            document.getElementById('summary-date-range').textContent = `${data.date_from} - ${data.date_to}`;
            document.getElementById('summary-revenue').textContent = `${data.period_revenue} ₸`;
            document.getElementById('summary-profit').textContent = `${data.period_profit} ₸`;
            document.getElementById('summary-margin').textContent = `${data.period_margin}%`;
            document.getElementById('summary-deals-count').textContent = data.period_deals_count;
            document.getElementById('summary-avg-check').textContent = `${data.period_avg_check} ₸`;

            // Обновляем таблицу сделок
            const tableBody = document.getElementById('deals-table-body');
            tableBody.innerHTML = ''; // Очищаем текущие строки

            data.deals.forEach(deal => {
                const row = `
                    <tr class="clickable-row" data-href="/deals/${deal.id}/">
                        <td>${deal.created_at}</td>
                        <td><code>${deal.deal_number}</code></td>
                        <td>${deal.client_nickname}</td>
                        <td><span class="badge ${deal.status_class}">${deal.status_display}</span></td>
                        <td><strong>${deal.total_amount} ₸</strong></td>
                        <td class="text-success"><strong>${deal.total_profit} ₸</strong></td>
                        <td>${deal.margin}%</td>
                        <td>${deal.items_count}</td>
                        <td>
                            <a href="/deals/${deal.id}/" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i> Детали
                            </a>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        })
        .catch(error => console.error('Ошибка при получении данных периода:', error));
}

// Инициализация при загрузке страницы, чтобы применить текущие фильтры
document.addEventListener('DOMContentLoaded', () => {
    const dateFromInput = document.querySelector('input[name="date_from"]');
    const dateToInput = document.querySelector('input[name="date_to"]');

    // Проверяем URL на наличие date_from и date_to
    const urlParams = new URLSearchParams(window.location.search);
    const urlDateFrom = urlParams.get('date_from');
    const urlDateTo = urlParams.get('date_to');

    if (urlDateFrom && urlDateTo) {
        dateFromInput.value = urlDateFrom;
        dateToInput.value = urlDateTo;
        updatePeriodData(urlDateFrom, urlDateTo);
        // Устанавливаем активную кнопку на основе URL-параметров
        const today = new Date();
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
        const quarterAgo = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
        const yearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());

        const currentPeriodMap = {
            [today.toISOString().split('T')[0]]: 'today',
            [weekAgo.toISOString().split('T')[0]]: 'week',
            [monthAgo.toISOString().split('T')[0]]: 'month',
            [quarterAgo.toISOString().split('T')[0]]: 'quarter',
            [yearAgo.toISOString().split('T')[0]]: 'year',
        };

        const periodName = currentPeriodMap[urlDateFrom];
        if (periodName && urlDateTo === today.toISOString().split('T')[0]) {
            setQuickPeriod(periodName); // Вызываем с именем периода, чтобы подсветка сработала
        }
    } else {
        // Устанавливаем период по умолчанию (последние 30 дней) и обновляем данные
        setQuickPeriod('month'); // Используем 'month' для 30 дней, как в логике view
    }

    // Добавляем обработчик для кнопки 'Применить'
    document.querySelector('#periods form').addEventListener('submit', function(event) {
        event.preventDefault(); // Предотвращаем стандартную отправку формы
        const dateFrom = dateFromInput.value;
        const dateTo = dateToInput.value;
        updatePeriodData(dateFrom, dateTo);
        // Снимаем активный класс со всех кнопок быстрого периода при ручном применении
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.classList.remove('active');
        });
    });

// Обработчик кликов по строкам в Топ 20
document.addEventListener('click', function(event) {
    const clickableRow = event.target.closest('.clickable-row');
    if (clickableRow && clickableRow.dataset.href) {
        window.location.href = clickableRow.dataset.href;
    }
});

});

// Инициализация графиков
function initCharts() {
    // 1. График заработка по неделям месяца
    const weeklyRevenueCtx = document.getElementById('weeklyRevenueChart').getContext('2d');
    new Chart(weeklyRevenueCtx, {
        type: 'bar',
        data: {
            labels: {{ week_labels|safe }},
            datasets: [{
                label: 'Заработок, ₸',
                data: {{ weekly_revenue|safe }},
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: '#28a745',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return new Intl.NumberFormat('ru-RU').format(value) + ' ₸';
                        }
                    }
                }
            }
        }
    });

    // 2. График топ 10 популярных тканей
    const topFabricsCtx = document.getElementById('topFabricsChart').getContext('2d');
    new Chart(topFabricsCtx, {
        type: 'bar',
        data: {
            labels: {{ fabric_names|safe }},
            datasets: [{
                label: 'Количество заказов',
                data: {{ fabric_counts|safe }},
                backgroundColor: [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1',
                    '#fd7e14', '#20c997', '#6c757d', '#e83e8c', '#17a2b8'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // 3. График количества сделок по неделям месяца
    const weeklyDealsCtx = document.getElementById('weeklyDealsChart').getContext('2d');
    new Chart(weeklyDealsCtx, {
        type: 'line',
        data: {
            labels: {{ week_labels|safe }},
            datasets: [{
                label: 'Количество сделок',
                data: {{ weekly_deals|safe }},
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#007bff',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // 4. График среднего чека за месяц
    const avgCheckCtx = document.getElementById('avgCheckChart').getContext('2d');
    new Chart(avgCheckCtx, {
        type: 'doughnut',
        data: {
            labels: {{ week_labels|safe }},
            datasets: [{
                label: 'Средний чек, ₸',
                data: {{ weekly_avg_check|safe }},
                backgroundColor: [
                    '#28a745', '#007bff', '#ffc107', '#dc3545', '#6f42c1'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + new Intl.NumberFormat('ru-RU').format(context.parsed) + ' ₸';
                        }
                    }
                }
            }
        }
    });
}

// Функция переключения между клиентами и тканями в Топ 20
function showTop20Tab(tabName) {
    const clientsContent = document.getElementById('clientsContent');
    const fabricsContent = document.getElementById('fabricsContent');
    const clientsTab = document.getElementById('clientsTab');
    const fabricsTab = document.getElementById('fabricsTab');

    if (tabName === 'clients') {
        // Показать клиентов
        clientsContent.style.display = 'block';
        fabricsContent.style.display = 'none';
        
        // Переключить активные кнопки
        clientsTab.classList.add('active');
        fabricsTab.classList.remove('active');
    } else if (tabName === 'fabrics') {
        // Показать ткани
        clientsContent.style.display = 'none';
        fabricsContent.style.display = 'block';
        
        // Переключить активные кнопки
        clientsTab.classList.remove('active');
        fabricsTab.classList.add('active');
    }
}

// Запуск инициализации графиков после загрузки Chart.js
document.addEventListener('DOMContentLoaded', function() {
    // Проверяем загружен ли Chart.js, если нет - загружаем
    if (typeof Chart === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = function() {
            initCharts();
        };
        document.head.appendChild(script);
    } else {
        initCharts();
    }
});

</script>
{% endblock %}

