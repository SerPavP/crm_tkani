{% extends 'base.html' %}
{% load deal_filters %}

{% block title %}Сделка {{ deal.deal_number }} - CRM Ткани{% endblock %}

{% block content %}
<!-- CSRF токен для AJAX запросов -->
{% csrf_token %}

<style>
    /* Стили для улучшенного интерфейса изменения статуса */
    .status-badge .badge {
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .status-btn {
        transition: all 0.3s ease;
        border-radius: 8px;
        font-weight: 500;
        padding: 10px 15px;
    }
    
    .status-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .status-btn:disabled {
        opacity: 0.6;
        transform: none;
        box-shadow: none;
    }
    
    .status-progress .progress {
        border-radius: 10px;
        overflow: hidden;
    }
    
    .status-progress .progress-bar {
        transition: width 0.5s ease;
    }
    
    /* Анимация для уведомлений */
    .alert {
        animation: slideInRight 0.3s ease;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* Улучшенные стили для карточек */
    .card {
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: box-shadow 0.3s ease;
    }
    
    .card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    .card-header {
        border-radius: 12px 12px 0 0 !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-cart"></i> Сделка {{ deal.deal_number }}</h1>
    <div>
        <a href="{% url 'deals:deal_edit' deal.id %}" class="btn btn-outline-secondary">
            <i class="bi bi-pencil"></i> Редактировать
        </a>
        <a href="{% url 'deals:export_deal_pdf' deal.id %}" class="btn btn-outline-danger">
            <i class="bi bi-file-earmark-pdf"></i> Экспорт в PDF
        </a>
        <a href="{% url 'deals:export_deal_excel' deal.id %}" class="btn btn-outline-success">
            <i class="bi bi-file-earmark-excel"></i> Экспорт в Excel
        </a>
        <a href="{% url 'deals:print_deal_warehouse' deal.id %}" class="btn btn-outline-info" target="_blank">
            <i class="bi bi-printer"></i> Печать на склад
        </a>
        <a href="{% url 'deals:deal_list' %}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> К списку
        </a>
    </div>
</div>

<div class="row">
    <!-- Информация о сделке -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Информация о сделке</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless table-sm">
                    <tr>
                        <td><strong>Номер:</strong></td>
                        <td>{{ deal.deal_number }}</td>
                    </tr>
                    <tr>
                        <td><strong>Клиент:</strong></td>
                        <td>
                            <a href="{% url 'clients:client_detail' deal.client.id %}" class="text-decoration-none">
                                {{ deal.client.nickname }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Телефон:</strong></td>
                        <td>{{ deal.client.phone }}</td>
                    </tr>
                    <tr>
                        <td><strong>Статус:</strong></td>
                        <td>
                            {% if deal.status == 'created' %}
                                <span class="badge bg-secondary">
                                    <i class="bi bi-file-earmark-plus"></i> {{ deal.get_status_display }}
                                </span>
                            {% elif deal.status == 'pending_payment' %}
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-clock"></i> {{ deal.get_status_display }}
                                </span>
                            {% elif deal.status == 'paid' %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle"></i> {{ deal.get_status_display }}
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Дата создания:</strong></td>
                        <td>{{ deal.created_at|date:"d.m.Y H:i" }}</td>
                    </tr>
                    {% if user.userprofile.role != 'accountant' %}
                    <tr>
                        <td><strong>Общая сумма (без НДС):</strong></td>
                        <td><strong class="text-success">{{ deal.total_amount|format_price }} ₸</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Общая сумма (с НДС):</strong></td>
                        <td><strong class="text-success">{{ deal.total_with_vat|format_price }} ₸</strong></td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>

        <!-- Изменение статуса -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-arrow-repeat"></i> Статус сделки</h6>
            </div>
            <div class="card-body">
                <div class="current-status mb-3">
                    <small class="text-muted">Текущий статус:</small>
                    <div class="status-badge mt-1">
                        {% if deal.status == 'created' %}
                            <span class="badge bg-secondary fs-6 px-3 py-2">
                                <i class="bi bi-file-earmark-plus"></i> Создан
                            </span>
                        {% elif deal.status == 'pending_payment' %}
                            <span class="badge bg-warning text-dark fs-6 px-3 py-2">
                                <i class="bi bi-clock"></i> Ожидание оплаты
                            </span>
                        {% elif deal.status == 'paid' %}
                            <span class="badge bg-success fs-6 px-3 py-2">
                                <i class="bi bi-check-circle"></i> Оплачен
                            </span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="status-actions">
                    <small class="text-muted d-block mb-2">Изменить на:</small>
                    <div class="d-grid gap-2">
                        {% for value, label in deal.STATUS_CHOICES %}
                            {% if deal.status != value %}
                                <button type="button" 
                                        class="btn btn-outline-primary status-btn" 
                                        data-status="{{ value }}"
                                        data-deal-id="{{ deal.id }}">
                                    {% if value == 'created' %}
                                        <i class="bi bi-file-earmark-plus"></i>
                                    {% elif value == 'pending_payment' %}
                                        <i class="bi bi-clock"></i>
                                    {% elif value == 'paid' %}
                                        <i class="bi bi-check-circle"></i>
                                    {% endif %}
                                    {{ label }}
                                </button>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Прогресс статусов -->
                <div class="status-progress mt-3">
                    <div class="progress" style="height: 8px;">
                        {% if deal.status == 'created' %}
                            <div class="progress-bar bg-secondary" style="width: 33%"></div>
                        {% elif deal.status == 'pending_payment' %}
                            <div class="progress-bar bg-secondary" style="width: 33%"></div>
                            <div class="progress-bar bg-warning" style="width: 33%"></div>
                        {% elif deal.status == 'paid' %}
                            <div class="progress-bar bg-secondary" style="width: 33%"></div>
                            <div class="progress-bar bg-warning" style="width: 33%"></div>
                            <div class="progress-bar bg-success" style="width: 34%"></div>
                        {% endif %}
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small class="text-muted">Создан</small>
                        <small class="text-muted">Ожидание оплаты</small>
                        <small class="text-muted">Оплачен</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Позиции заказа -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list"></i> Позиции заказа</h5>
                <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addItemModal">
                    <i class="bi bi-plus"></i> Добавить позицию
                </button>
            </div>
            <div class="card-body">
                {% if deal_items %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">№</th>
                                    <th>Ткань</th>
                                    <th>Цвет</th>
                                    <th style="width: 120px;">Количество (м)</th>
                                    <th style="width: 120px;">Цена за м</th>
                                    <th style="min-width: 180px; width: auto;">Сумма</th>
                                    <th style="width: 120px;">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in deal_items %}
                                    <tr data-item-id="{{ item.id }}">
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            <div class="editable-cell" data-field="fabric">
                                                <span class="display-value">{{ item.fabric_color.fabric.name }}</span>
                                                <select class="form-control form-control-sm edit-input fabric-select" 
                                                        style="display: none;">
                                                    <option value="">Выберите ткань</option>
                                                    {% for fabric in fabrics %}
                                                        <option value="{{ fabric.id }}" 
                                                                {% if fabric.id == item.fabric_color.fabric.id %}selected{% endif %}>
                                                            {{ fabric.name }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="editable-cell" data-field="fabric_color">
                                                <div class="display-value">
                                                    <div class="d-flex align-items-center">
                                                        <div class="color-preview me-2" 
                                                             style="width: 20px; height: 20px; background-color: {{ item.fabric_color.color_hex }}; border: 1px solid #ddd; border-radius: 3px;">
                                                        </div>
                                                        {{ item.fabric_color.color_name }} (№{{ item.fabric_color.color_number }})
                                                    </div>
                                                </div>
                                                <select class="form-control form-control-sm edit-input color-select" 
                                                        style="display: none;" disabled>
                                                    <option value="{{ item.fabric_color.id }}" selected>
                                                        {{ item.fabric_color.color_name }} (№{{ item.fabric_color.color_number }})
                                                    </option>
                                                </select>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="editable-cell" data-field="width_meters">
                                                <span class="display-value">{{ item.width_meters }}</span>
                                                <input type="number" class="form-control form-control-sm edit-input" 
                                                       value="{{ item.width_meters }}" 
                                                       step="0.01" min="0.01" style="width: 100px; display: none;">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="editable-cell" data-field="price_per_meter">
                                                <span class="display-value">{{ item.price_per_meter|format_price }} ₸</span>
                                                <input type="number" class="form-control form-control-sm edit-input" 
                                                       value="{{ item.price_per_meter }}" 
                                                       step="0.01" min="0.01" style="width: 100px; display: none;">
                                            </div>
                                            {% if user.userprofile.role == 'admin' %}
                                            <div class="small text-muted">
                                                Себестоимость: {{ item.fabric_color.fabric.cost_price|format_price }} ₸
                                            </div>
                                            {% elif user.userprofile.role == 'accountant' %}
                                            <div class="small text-muted">
                                                {{ item.price_per_meter|format_price }} ₸
                                            </div>
                                            {% endif %}
                                        </td>
                                        <td class="total-cell" style="min-width: 180px; width: auto;"><strong>{{ item.total_price|format_price }} ₸</strong></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary edit-item-btn" 
                                                    data-item-id="{{ item.id }}" title="Редактировать">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-success save-item-btn" 
                                                    data-item-id="{{ item.id }}" title="Сохранить" style="display: none;">
                                                <i class="bi bi-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary cancel-item-btn" 
                                                    data-item-id="{{ item.id }}" title="Отмена" style="display: none;">
                                                <i class="bi bi-x"></i>
                                            </button>
                                            <form method="post" action="{% url 'deals:remove_deal_item' deal.id item.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                                        onclick="return confirm('Удалить эту позицию?')" title="Удалить">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-success">
                                    <th colspan="5" class="text-end fs-5 fw-bold" style="padding-right: 20px;">Итого:</th>
                                    <th class="fs-5 fw-bold deal-total text-end" style="min-width: 200px; width: auto;">{{ deal.total_amount|format_price }} ₸</th>
                                    <th style="width: 120px;"></th>
                                </tr>
                                {% if user.userprofile.role == 'admin' %}
                                    {% if total_profit > 0 %}
                                    <tr class="table-info">
                                        <th colspan="5" class="text-end fs-6" style="padding-right: 20px;">Прибыль компании:</th>
                                        <th class="text-success fs-6 fw-bold deal-profit text-end" style="min-width: 200px; width: auto;">+{{ total_profit|format_price }} ₸</th>
                                        <th style="width: 120px;"></th>
                                    </tr>
                                    {% elif total_profit < 0 %}
                                    <tr class="table-warning">
                                        <th colspan="5" class="text-end fs-6" style="padding-right: 20px;">Убыток компании:</th>
                                        <th class="text-danger fs-6 fw-bold deal-profit text-end" style="min-width: 200px; width: auto;">{{ total_profit|format_price }} ₸</th>
                                        <th style="width: 120px;"></th>
                                    </tr>
                                    {% endif %}
                                {% endif %}
                            </tfoot>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-cart-x display-4 text-muted"></i>
                        <h5 class="text-muted mt-3">Позиции не добавлены</h5>
                        <p class="text-muted">Добавьте первую позицию в заказ</p>
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addItemModal">
                            <i class="bi bi-plus"></i> Добавить позицию
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления позиции -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить позицию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'deals:add_deal_item' deal.id %}" id="addItemForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="fabric_select" class="form-label">Ткань</label>
                        <select name="fabric" id="fabric_select" class="form-select" required>
                            <option value="">Выберите ткань</option>
                            {% for fabric in fabrics %}
                                <option value="{{ fabric.id }}">{{ fabric.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="fabric_color" class="form-label">Цвет</label>
                        <select name="fabric_color" id="fabric_color" class="form-select" disabled required>
                            <option value="">Сначала выберите ткань</option>
                        </select>
                    </div>
                    <div class="mb-3" id="rolls_count_display" style="display: none;">
                        <label class="form-label">Рулоны в наличии:</label>
                        <div class="form-control-plaintext" id="active_rolls_count">0 рулонов</div>
                    </div>
                    <div class="mb-3">
                        <label for="price_per_meter" class="form-label">Цена за метр (₸)</label>
                        <input type="number" name="price_per_meter" id="price_per_meter" class="form-control" 
                               step="0.01" min="0.01" required placeholder="0.00">
                        {% if user.userprofile.can_view_finances %}
                        <div class="form-text">
                            <small class="text-muted">Себестоимость: <span id="cost_price_display">Будет показана после выбора цвета</span></small>
                        </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="width_meters" class="form-label">Количество метров</label>
                        <input type="number" name="width_meters" id="width_meters" class="form-control" 
                               step="0.01" min="0.01" required placeholder="0.00">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Итоговая сумма</label>
                        <div class="form-control-plaintext" id="total_preview">0.00 ₸</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Добавляем стили для невалидных полей и улучшения таблицы
    document.head.insertAdjacentHTML('beforeend', `
    <style>
    .edit-input.is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
    .edit-input:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    /* Улучшение стиля таблицы */
    .table tfoot {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .table tfoot tr:first-child {
        border-top: 3px solid #28a745;
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    }
    
    .table tfoot tr:first-child th {
        color: #155724;
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .table tfoot tr:not(:first-child) th {
        font-weight: 600;
        color: #495057;
    }
    
    .deal-total {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white !important;
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        min-width: 200px !important;
        width: auto !important;
        text-align: right !important;
        font-family: 'Courier New', monospace !important;
        font-weight: bold !important;
    }
    
    .deal-profit {
        border-radius: 6px;
        padding: 8px 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        min-width: 200px !important;
        width: auto !important;
        text-align: right !important;
        font-family: 'Courier New', monospace !important;
        font-weight: bold !important;
    }
    
    .table tbody tr:hover {
        background-color: rgba(0,123,255,0.05);
        transition: background-color 0.2s ease;
    }
    
    /* Стили для колонки с суммами */
    .total-cell {
        min-width: 180px !important;
        width: auto !important;
        text-align: right !important;
        font-family: 'Courier New', monospace !important;
        font-weight: bold !important;
    }
    
    /* Стили для заголовка колонки "Сумма" */
    .table thead th:nth-child(6) {
        min-width: 180px !important;
        width: auto !important;
        text-align: right !important;
    }
    </style>
    `);

    // Инициализация модального окна добавления позиции
    const fabricSelect = document.getElementById('fabric_select');
    const fabricColorSelect = document.getElementById('fabric_color');
    const priceInput = document.getElementById('price_per_meter');
    const widthInput = document.getElementById('width_meters');
    const totalPreview = document.getElementById('total_preview');
    const rollsCountDisplay = document.getElementById('rolls_count_display');
    const activeRollsCountElement = document.getElementById('active_rolls_count');

    if (fabricSelect && fabricColorSelect) {
        // Обработка выбора ткани в модальном окне
        fabricSelect.addEventListener('change', function() {
            const fabricId = this.value;
            console.log('Выбрана ткань с ID:', fabricId);
            
            // Очищаем и блокируем выбор цвета
            fabricColorSelect.innerHTML = '<option value="">Загрузка...</option>';
            fabricColorSelect.disabled = true;
            priceInput.value = '';
            rollsCountDisplay.style.display = 'none'; // Hide rolls count until color is selected
            activeRollsCountElement.textContent = '0 рулонов';
            
            if (fabricId) {
                // Получаем цвета для выбранной ткани
                const url = `/deals/api/fabric-colors/?fabric_id=${fabricId}`;
                console.log('Загружаем цвета по URL:', url);
                
                fetch(url)
                    .then(response => {
                        console.log('Ответ сервера:', response.status, response.statusText);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Полученные данные:', data);
                        fabricColorSelect.innerHTML = '<option value="">Выберите цвет</option>';
                        
                        if (data.colors && data.colors.length > 0) {
                            data.colors.forEach(color => {
                                const option = document.createElement('option');
                                option.value = color.id;
                                option.textContent = `${color.name} (№${color.number})`;
                                option.dataset.price = color.price_per_meter;
                                option.dataset.hex = color.hex;
                                option.dataset.costPrice = color.cost_price;
                                option.dataset.rollsCount = color.active_rolls_count; // Add rolls count
                                fabricColorSelect.appendChild(option);
                            });
                            
                            fabricColorSelect.disabled = false;
                            console.log('Цвета загружены, select активирован');
                        } else {
                            fabricColorSelect.innerHTML = '<option value="">Нет доступных цветов</option>';
                            console.log('Нет цветов для выбранной ткани');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка загрузки цветов:', error);
                        fabricColorSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
                    });
            } else {
                fabricColorSelect.innerHTML = '<option value="">Сначала выберите ткань</option>';
            }
        });

        // Обработка выбора цвета в модальном окне
        fabricColorSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.dataset.price) {
                // Конвертируем цену в правильный формат для input
                const price = selectedOption.dataset.price.replace(',', '.');
                priceInput.value = price;
                updateTotal();
            }
            
            // Показываем себестоимость если есть права на финансы
            {% if user.userprofile.can_view_finances %}
            if (selectedOption.dataset.costPrice) {
                const costPrice = selectedOption.dataset.costPrice.replace(',', '.');
                const costPriceText = parseFloat(costPrice).toLocaleString('ru-RU', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                const formText = priceInput.parentNode.querySelector('.form-text');
                if (formText) {
                    formText.innerHTML = `<small class="text-muted">Себестоимость: ${costPriceText} ₸</small>`;
                }
            }
            {% endif %}

            // Показываем количество рулонов
            if (selectedOption.dataset.rollsCount) {
                activeRollsCountElement.textContent = `${selectedOption.dataset.rollsCount} рулонов`;
                rollsCountDisplay.style.display = 'block';
            } else {
                rollsCountDisplay.style.display = 'none';
                activeRollsCountElement.textContent = '0 рулонов';
            }
        });

        // Обновление итоговой суммы в модальном окне
        function updateTotal() {
            const width = parseFloat(widthInput.value.replace(',', '.')) || 0;
            const price = parseFloat(priceInput.value.replace(',', '.')) || 0;
            const total = width * price;
            if (totalPreview) {
                // Форматируем сумму с разделителями тысяч
                const formattedTotal = total.toLocaleString('ru-RU', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                totalPreview.textContent = formattedTotal + ' ₸';
            }
        }

        if (widthInput) widthInput.addEventListener('input', updateTotal);
        if (priceInput) priceInput.addEventListener('input', updateTotal);
        
        // Обработка отправки формы добавления позиции
        const addItemForm = document.getElementById('addItemForm');
        if (addItemForm) {
            addItemForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return response.text().then(html => {
                            // Если получили HTML, значит есть ошибки
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const errorMessages = doc.querySelectorAll('.alert-danger, .errorlist');
                            
                            if (errorMessages.length > 0) {
                                throw new Error('Ошибка добавления позиции: ' + errorMessages[0].textContent);
                            } else {
                                throw new Error('Ошибка добавления позиции');
                            }
                        });
                    }
                })
                .then(data => {
                    if (data.success) {
                        // Закрываем модальное окно
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
                        if (modal) {
                            modal.hide();
                        }
                        // Перезагружаем страницу для обновления всех данных
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Ошибка отправки формы:', error);
                    alert('Ошибка добавления позиции');
                });
            });
        }
    }

    // Редактирование позиций в таблице
    function initializeEditButtons() {
        const editButtons = document.querySelectorAll('.edit-item-btn');
        console.log('Найдено кнопок редактирования:', editButtons.length);
        
        editButtons.forEach((button, index) => {
            console.log(`Инициализация кнопки ${index + 1}:`, button);
            
            // Удаляем старые обработчики если есть
            button.removeEventListener('click', button.editHandler);
            
            // Создаем новый обработчик
            button.editHandler = function() {
                console.log('Кнопка редактирования нажата!');
                const itemId = this.dataset.itemId;
                const row = this.closest('tr');
                const editableCells = row.querySelectorAll('.editable-cell');
                
                // Переключаем отображение на поля ввода
                editableCells.forEach(cell => {
                    cell.querySelector('.display-value').style.display = 'none';
                    const editInput = cell.querySelector('.edit-input');
                    editInput.style.display = 'block';
                    
                    // Устанавливаем исходные значения для полей количества и цены
                    if (cell.dataset.field === 'width_meters' || cell.dataset.field === 'price_per_meter') {
                        const originalValue = cell.querySelector('.display-value').textContent.replace(' ₸', '').replace(/\./g, '').replace(',', '.');
                        editInput.value = originalValue;
                    }
                    
                    // Включаем цвет если ткань уже выбрана
                    if (cell.dataset.field === 'fabric_color') {
                        const fabricSelect = row.querySelector('.fabric-select');
                        if (fabricSelect.value) {
                            editInput.disabled = false;
                        }
                    }
                });
                
                // Переключаем кнопки
                this.style.display = 'none';
                row.querySelector('.save-item-btn').style.display = 'inline-block';
                row.querySelector('.cancel-item-btn').style.display = 'inline-block';
            };
            
            // Добавляем обработчик
            button.addEventListener('click', button.editHandler);
        });
    }

    // Отмена редактирования
    function initializeCancelButtons() {
        const cancelButtons = document.querySelectorAll('.cancel-item-btn');
        cancelButtons.forEach(button => {
            button.addEventListener('click', function() {
                const row = this.closest('tr');
                
                // Возвращаем отображение к текстовому виду
                row.querySelectorAll('.display-value').forEach(display => display.style.display = 'block');
                row.querySelectorAll('.edit-input').forEach(input => {
                    input.style.display = 'none';
                    // Возвращаем исходные значения для select элементов
                    if (input.tagName === 'SELECT') {
                        const originalValue = input.querySelector('option[selected]')?.value || '';
                        input.value = originalValue;
                    }
                });
                
                // Переключаем кнопки
                this.style.display = 'none';
                row.querySelector('.save-item-btn').style.display = 'none';
                row.querySelector('.edit-item-btn').style.display = 'inline-block';
            });
        });
    }

    // Инициализируем кнопки отмены
    initializeCancelButtons();

    // Обработка изменения ткани
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('edit-input')) {
            // Убираем класс ошибки при изменении значения
            e.target.classList.remove('is-invalid');
        }
        
        if (e.target.classList.contains('fabric-select')) {
            const fabricId = e.target.value;
            const row = e.target.closest('tr');
            const colorCell = row.querySelector('[data-field="fabric_color"]');
            const colorSelect = colorCell.querySelector('.color-select');
            const priceCell = row.querySelector('[data-field="price_per_meter"]');
            const priceInput = priceCell.querySelector('.edit-input');
            const widthCell = row.querySelector('[data-field="width_meters"]');
            const widthInput = widthCell.querySelector('.edit-input');
            
            // Сброс всех полей при смене ткани
            colorSelect.innerHTML = '<option value="">Загрузка...</option>';
            colorSelect.disabled = true;
            priceInput.value = '';
            widthInput.value = '';
            updateRowTotal(row);
            
            if (fabricId) {
                // Загружаем цвета для выбранной ткани
                fetch(`/deals/api/fabric-colors/?fabric_id=${fabricId}`)
                    .then(response => response.json())
                    .then(data => {
                        colorSelect.innerHTML = '<option value="">Выберите цвет</option>';
                        
                        data.colors.forEach(color => {
                            const option = document.createElement('option');
                            option.value = color.id;
                            option.textContent = `${color.name} (№${color.number})`;
                            option.dataset.price = color.price_per_meter;
                            option.dataset.hex = color.hex;
                            option.dataset.costPrice = color.cost_price;
                            colorSelect.appendChild(option);
                        });
                        
                        colorSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Ошибка загрузки цветов:', error);
                        colorSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
                    });
            } else {
                colorSelect.innerHTML = '<option value="">Сначала выберите ткань</option>';
            }
        }
        
        // Обработка изменения цвета
        if (e.target.classList.contains('color-select')) {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const row = e.target.closest('tr');
            const priceCell = row.querySelector('[data-field="price_per_meter"]');
            const priceInput = priceCell.querySelector('.edit-input');
            
            if (selectedOption.dataset.price) {
                // Конвертируем цену в правильный формат для input
                const price = selectedOption.dataset.price.replace(',', '.');
                priceInput.value = price;
                updateRowTotal(row);
            }
        }
    });

    // Обновление суммы при изменении количества и цены
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('edit-input')) {
            // Убираем класс ошибки при изменении значения
            e.target.classList.remove('is-invalid');
            
            if (e.target.closest('[data-field="width_meters"]') || e.target.closest('[data-field="price_per_meter"]')) {
                updateRowTotal(e.target.closest('tr'));
            }
        }
    });
    
    // Функция обновления суммы строки
    function updateRowTotal(row) {
        const widthCell = row.querySelector('[data-field="width_meters"]');
        const priceCell = row.querySelector('[data-field="price_per_meter"]');
        const totalCell = row.querySelector('.total-cell');
        
        const widthInput = widthCell.querySelector('.edit-input');
        const priceInput = priceCell.querySelector('.edit-input');
        
        const width = parseFloat(widthInput.value.replace(',', '.')) || 0;
        const price = parseFloat(priceInput.value.replace(',', '.')) || 0;
        const total = width * price;
        
        // Форматируем сумму с разделителями тысяч
        const formattedTotal = total.toLocaleString('ru-RU', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        
        totalCell.innerHTML = `<strong>${formattedTotal} ₸</strong>`;
        
        // Пересчитываем общую сумму сделки
        recalculateDealTotal();
    }

    // Сохранение изменений позиции
    function initializeSaveButtons() {
        const saveButtons = document.querySelectorAll('.save-item-btn');
        saveButtons.forEach(button => {
            button.addEventListener('click', function() {
            const itemId = this.dataset.itemId;
            const row = this.closest('tr');
            
            // Собираем данные всех полей
            const fabricSelect = row.querySelector('.fabric-select');
            const colorSelect = row.querySelector('.color-select');
            const widthInput = row.querySelector('[data-field="width_meters"] .edit-input');
            const priceInput = row.querySelector('[data-field="price_per_meter"] .edit-input');
            
            // Проверяем обязательные поля
            let hasErrors = false;
            
            // Сброс предыдущих ошибок
            row.querySelectorAll('.edit-input').forEach(input => {
                input.classList.remove('is-invalid');
            });
            
            let errorMessage = '';
            
            if (!fabricSelect.value) {
                fabricSelect.classList.add('is-invalid');
                errorMessage = 'Выберите ткань';
                hasErrors = true;
            }
            if (!colorSelect.value) {
                colorSelect.classList.add('is-invalid');
                if (!errorMessage) errorMessage = 'Выберите цвет ткани';
                hasErrors = true;
            }
            if (!widthInput.value || parseFloat(widthInput.value.replace(',', '.')) <= 0) {
                widthInput.classList.add('is-invalid');
                if (!errorMessage) errorMessage = 'Введите корректное количество метров';
                hasErrors = true;
            }
            if (!priceInput.value || parseFloat(priceInput.value.replace(',', '.')) <= 0) {
                priceInput.classList.add('is-invalid');
                if (!errorMessage) errorMessage = 'Введите корректную цену за метр';
                hasErrors = true;
            }
            
            if (hasErrors) {
                alert(errorMessage || 'Заполните все обязательные поля корректно');
                return;
            }
            
            const data = {
                fabric_color: colorSelect.value,
                width_meters: widthInput.value,
                price_per_meter: priceInput.value,
                csrfmiddlewaretoken: document.querySelector('[name=csrfmiddlewaretoken]').value
            };

            fetch(`{% url 'deals:edit_deal_item' deal.id 0 %}`.replace('0', itemId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Обновляем отображаемые значения
                    const fabricDisplay = row.querySelector('[data-field="fabric"] .display-value');
                    const colorDisplay = row.querySelector('[data-field="fabric_color"] .display-value');
                    const widthDisplay = row.querySelector('[data-field="width_meters"] .display-value');
                    const priceDisplay = row.querySelector('[data-field="price_per_meter"] .display-value');
                    
                    // Обновляем отображение ткани
                    const selectedFabric = fabricSelect.options[fabricSelect.selectedIndex];
                    fabricDisplay.textContent = selectedFabric.textContent;
                    
                    // Обновляем отображение цвета
                    const selectedColor = colorSelect.options[colorSelect.selectedIndex];
                    const colorHex = selectedColor.dataset.hex || '#cccccc';
                    colorDisplay.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="color-preview me-2" 
                                 style="width: 20px; height: 20px; background-color: ${colorHex}; border: 1px solid #ddd; border-radius: 3px;">
                            </div>
                            ${selectedColor.textContent}
                        </div>
                    `;
                    
                    // Обновляем количество и цену
                    widthDisplay.textContent = widthInput.value;
                    priceDisplay.textContent = priceInput.value + ' ₸';
                    
                    // Переключаем обратно на режим просмотра
                    row.querySelectorAll('.display-value').forEach(display => display.style.display = 'block');
                    row.querySelectorAll('.edit-input').forEach(input => input.style.display = 'none');
                    
                    // Переключаем кнопки
                    this.style.display = 'none';
                    row.querySelector('.cancel-item-btn').style.display = 'none';
                    row.querySelector('.edit-item-btn').style.display = 'inline-block';
                    
                    // Обновляем общую сумму сделки
                    if (result.deal_total) {
                        updateDealTotal(result.deal_total);
                    }
                } else {
                    alert('Ошибка сохранения: ' + (result.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Ошибка сохранения:', error);
                alert('Ошибка сохранения позиции');
            });
        });
    });
    }

    // Инициализируем кнопки сохранения
    initializeSaveButtons();
    
    // Инициализируем кнопки редактирования
    initializeEditButtons();
    
    // Инициализируем кнопки отмены
    initializeCancelButtons();
    
    // Функция для обновления общей суммы сделки
    function updateDealTotal(totalAmount) {
        const dealTotalElement = document.querySelector('.deal-total');
        if (dealTotalElement) {
            // Форматируем сумму с разделителями тысяч
            const formattedAmount = parseFloat(totalAmount).toLocaleString('ru-RU', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            dealTotalElement.textContent = formattedAmount + ' ₸';
        }
        
        // Обновляем общие суммы в информационной панели (только если пользователь не бухгалтер)
        {% if user.userprofile.role != 'accountant' %}
        const allTds = document.querySelectorAll('td');
        let totalWithoutVatElement = null;
        let totalWithVatElement = null;
        
        allTds.forEach(td => {
            if (td.textContent.includes('Общая сумма (без НДС):')) {
                const nextTd = td.nextElementSibling;
                if (nextTd) {
                    totalWithoutVatElement = nextTd.querySelector('strong');
                }
            }
            if (td.textContent.includes('Общая сумма (с НДС):')) {
                const nextTd = td.nextElementSibling;
                if (nextTd) {
                    totalWithVatElement = nextTd.querySelector('strong');
                }
            }
        });
        
        if (totalWithoutVatElement) {
            const formattedAmount = parseFloat(totalAmount).toLocaleString('ru-RU', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            totalWithoutVatElement.textContent = formattedAmount + ' ₸';
        }
        
        // Обновляем сумму с НДС (12%)
        const totalWithVat = totalAmount * 1.12;
        if (totalWithVatElement) {
            const formattedTotalWithVat = totalWithVat.toLocaleString('ru-RU', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            totalWithVatElement.textContent = formattedTotalWithVat + ' ₸';
        }
        {% endif %}
        
        // Обновляем прибыль компании (только для админов)
        {% if user.userprofile.role == 'admin' %}
        const profitElement = document.querySelector('.deal-profit');
        if (profitElement) {
            const profit = totalAmount * 0.3;
            const formattedProfit = profit.toLocaleString('ru-RU', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            profitElement.textContent = '+' + formattedProfit + ' ₸';
        }
        {% endif %}
    }
    
    // Функция для пересчета общей суммы на основе всех строк
    function recalculateDealTotal() {
        let total = 0;
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const totalCell = row.querySelector('.total-cell');
            if (totalCell) {
                const totalText = totalCell.textContent.replace(' ₸', '').replace(/\./g, '').replace(',', '.');
                const rowTotal = parseFloat(totalText) || 0;
                total += rowTotal;
            }
        });
        
        updateDealTotal(total);
    }
    
    // Обработка изменения статуса сделки
    function initializeStatusButtons() {
        console.log('Инициализация кнопок статуса...');
        const statusButtons = document.querySelectorAll('.status-btn');
        console.log('Найдено кнопок статуса:', statusButtons.length);
        
        statusButtons.forEach(button => {
            console.log('Добавляем обработчик для кнопки:', button);
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Кнопка нажата!');
                const status = this.getAttribute('data-status');
                const dealId = this.getAttribute('data-deal-id');
                console.log('Статус:', status, 'ID сделки:', dealId);
                
                // Блокируем кнопку
                this.disabled = true;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i> Изменение...';
                    
                    // Получаем CSRF токен
                    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || 
                                     document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                     document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                    console.log('CSRF токен:', csrfToken);
                    
                    if (!csrfToken) {
                        console.error('CSRF токен не найден!');
                        showNotification('Ошибка безопасности: CSRF токен не найден', 'error');
                        restoreButton(this, status);
                        return;
                    }
                    
                    // Отправляем AJAX запрос
                    const url = `/deals/${dealId}/change-status/`;
                    const body = `status=${status}`;
                    console.log('Отправляем запрос на:', url);
                    console.log('Тело запроса:', body);
                    
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: body
                    })
                    .then(response => {
                        console.log('Получен ответ:', response);
                        console.log('Статус ответа:', response.status);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        return response.json();
                    })
                    .then(data => {
                        console.log('Данные ответа:', data);
                        if (data.success) {
                            // Показываем уведомление об успехе
                            showNotification('Статус успешно изменен!', 'success');
                            
                            // Обновляем интерфейс
                            updateStatusUI(status);
                            
                            // Перезагружаем страницу через небольшую задержку
                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                        } else {
                            showNotification(data.error || 'Ошибка при изменении статуса', 'error');
                            // Восстанавливаем кнопку
                            restoreButton(this, status);
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при парсинге JSON:', error);
                        showNotification('Ошибка при обработке ответа сервера', 'error');
                        // Восстанавливаем кнопку
                        restoreButton(this, status);
                    });
            });
        });
    }
    
    // Функция для восстановления кнопки
    function restoreButton(button, status) {
        button.disabled = false;
        if (status === 'created') {
            button.innerHTML = '<i class="bi bi-file-earmark-plus"></i> Создан';
        } else if (status === 'pending_payment') {
            button.innerHTML = '<i class="bi bi-clock"></i> Ожидание оплаты';
        } else if (status === 'paid') {
            button.innerHTML = '<i class="bi bi-check-circle"></i> Оплачен';
        }
    }
    
    // Функция для обновления UI статуса
    function updateStatusUI(newStatus) {
        const statusBadge = document.querySelector('.status-badge');
        const statusActions = document.querySelector('.status-actions');
        const progressBar = document.querySelector('.status-progress .progress');
        
        // Обновляем бейдж статуса
        if (statusBadge) {
            let badgeHTML = '';
            if (newStatus === 'created') {
                badgeHTML = '<span class="badge bg-secondary fs-6 px-3 py-2"><i class="bi bi-file-earmark-plus"></i> Создан</span>';
            } else if (newStatus === 'pending_payment') {
                badgeHTML = '<span class="badge bg-warning text-dark fs-6 px-3 py-2"><i class="bi bi-clock"></i> Ожидание оплаты</span>';
            } else if (newStatus === 'paid') {
                badgeHTML = '<span class="badge bg-success fs-6 px-3 py-2"><i class="bi bi-check-circle"></i> Оплачен</span>';
            }
            statusBadge.innerHTML = badgeHTML;
        }
        
        // Обновляем прогресс-бар
        if (progressBar) {
            let progressHTML = '';
            if (newStatus === 'created') {
                progressHTML = '<div class="progress-bar bg-secondary" style="width: 33%"></div>';
            } else if (newStatus === 'pending_payment') {
                progressHTML = '<div class="progress-bar bg-secondary" style="width: 33%"></div><div class="progress-bar bg-warning" style="width: 33%"></div>';
            } else if (newStatus === 'paid') {
                progressHTML = '<div class="progress-bar bg-secondary" style="width: 33%"></div><div class="progress-bar bg-warning" style="width: 33%"></div><div class="progress-bar bg-success" style="width: 34%"></div>';
            }
            progressBar.innerHTML = progressHTML;
        }
    }
    
    // Функция для показа уведомлений
    function showNotification(message, type) {
        // Создаем элемент уведомления
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Добавляем на страницу
        document.body.appendChild(notification);
        
        // Автоматически скрываем через 3 секунды
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }
    
    // Инициализируем все кнопки
    initializeEditButtons();
    initializeSaveButtons();
    initializeCancelButtons();
    initializeStatusButtons();
    
    // Дополнительная проверка через небольшую задержку для надежности
    setTimeout(() => {
        console.log('Дополнительная проверка кнопок...');
        initializeEditButtons();
        initializeSaveButtons();
        initializeCancelButtons();
        initializeStatusButtons();
    }, 1000);
});
</script>
{% endblock %}

