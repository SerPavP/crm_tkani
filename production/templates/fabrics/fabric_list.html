{% extends 'base.html' %}
{% load deal_filters %}

{% block title %}–¢–∫–∞–Ω–∏ - CRM –¢–∫–∞–Ω–∏{% endblock %}

<style>
.btn-action {
    transition: all 0.3s ease;
    border: none;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    filter: brightness(0.9);
}

.btn-action:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>

{% block content %}
{% csrf_token %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-palette"></i> –¢–∫–∞–Ω–∏</h1>
</div>

<!-- –ü–æ–∏—Å–∫ –∏ –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
<div class="row mb-4">
    <div class="col-md-6">
        <form method="get" class="d-flex">
            <input type="text" name="search" class="form-control" 
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–∫–∞–Ω–∏ –∏–ª–∏ –Ω–æ–º–µ—Ä—É —Ü–≤–µ—Ç–∞..." 
                   value="{{ search_query }}">
            <button type="submit" class="btn btn-outline-secondary ms-2">
                <i class="bi bi-search"></i>
            </button>
            {% if search_query %}
                <a href="{% url 'fabrics:fabric_list' %}" class="btn btn-outline-danger ms-2">
                    <i class="bi bi-x"></i>
                </a>
            {% endif %}
        </form>
    </div>
    <div class="col-md-6 text-end">
        <a href="{% url 'fabrics:fabric_create' %}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å —Ç–∫–∞–Ω—å
        </a>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Ç–∫–∞–Ω–µ–π -->
{% if fabrics %}
    <div class="row">
        {% for fabric in fabrics %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <a href="{% url 'fabrics:fabric_detail' fabric.id %}" class="text-decoration-none">
                                {{ fabric.name }}
                            </a>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if user.userprofile.can_view_finances %}
                            <p class="text-muted mb-2">
                                <small>
                                    –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: {{ fabric.cost_price|format_price }} ‚Ç∏ | 
                                    –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: {{ fabric.selling_price|format_price }} ‚Ç∏
                                </small>
                            </p>
                        {% endif %}
                        
                        <!-- –¶–≤–µ—Ç–∞ —Ç–∫–∞–Ω–∏ (—Å–Ω–∞—á–∞–ª–∞ —Å —Ä—É–ª–æ–Ω–∞–º–∏, –ø–æ—Ç–æ–º –±–µ–∑) -->
                        {% for color in fabric.sorted_colors %}
                            <div class="d-flex align-items-center mb-2">
                                <div class="color-cube me-2" 
                                     style="width: 20px; height: 20px; background-color: {{ color.color_hex }}; border: 1px solid #ccc; border-radius: 3px;">
                                </div>
                                <div class="flex-grow-1">
                                    <strong>{{ color.color_name }} (‚Ññ{{ color.color_number }})</strong>
                                    <div class="small text-muted">
                                        {% with rolls=color.active_rolls_simple %}
                                            {% if rolls %}
                                                {% if rolls|length > 4 %}
                                                    <div class="rolls-display">
                                                        <span class="rolls-preview">
                                                            {% for roll in rolls|slice:":4" %}{{ roll }}–º {% endfor %}...
                                                        </span>
                                                        <span class="text-primary" style="cursor: pointer;" onclick="toggleRolls(this)">
                                                            –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
                                                        </span>
                                                        <div class="rolls-full" style="display: none;">
                                                            {% for roll in rolls %}{{ roll }}–º {% endfor %}
                                                        </div>
                                                        | –∏—Ç–æ–≥–æ: <strong>{{ color.total_width_meters_formatted }}</strong>
                                                    </div>
                                                {% else %}
                                                    {% for roll in rolls %}{{ roll }}–º {% endfor %}| –∏—Ç–æ–≥–æ: <strong>{{ color.total_width_meters_formatted }}</strong>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-danger">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                                            {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>
                                {% if user.userprofile.can_view_finances %}
                                    <div class="text-end">
                                        <a href="{% url 'fabrics:color_edit' color.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        {% empty %}
                            <p class="text-muted">–¶–≤–µ—Ç–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
                        {% endfor %}
                        
                        <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫—Ä—ã—Ç—ã—Ö —Ü–≤–µ—Ç–æ–≤ -->
                        {% if fabric.sorted_colors|length > 5 %}
                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    +{{ fabric.sorted_colors|length|add:"-5" }} —Ü–≤–µ—Ç–æ–≤ –µ—â–µ
                                </small>
                            </div>
                        {% endif %}
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <a href="{% url 'fabrics:fabric_detail' fabric.id %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </a>
                            <small class="text-muted">
                                –í—Å–µ–≥–æ: {{ fabric.total_width_meters_formatted }}
                            </small>
                        </div>
                        {% if user.userprofile.can_view_finances %}
                        <div class="d-flex gap-1">
                            <a href="{% url 'fabrics:fabric_edit' fabric.id %}" class="btn btn-secondary btn-sm flex-fill btn-action">
                                <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                            <a href="{% url 'fabrics:color_create' fabric.id %}" class="btn btn-info btn-sm flex-fill btn-action">
                                <i class="bi bi-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ü–≤–µ—Ç
                            </a>
                            <button class="btn btn-danger btn-sm flex-fill btn-action" 
                                    data-fabric-id="{{ fabric.id }}"
                                    data-fabric-name="{{ fabric.name|escapejs }}"
                                    data-deals-count="{{ fabric.deals_count }}"
                                    data-colors-count="{{ fabric.fabriccolor_set.count }}"
                                    onclick="confirmDeleteFabric(this)">
                                <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center py-5">
        <i class="bi bi-palette display-1 text-muted"></i>
        <h3 class="text-muted mt-3">
            {% if search_query %}
                –¢–∫–∞–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
            {% else %}
                –¢–∫–∞–Ω–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
            {% endif %}
        </h3>
        {% if user.userprofile.can_view_finances and not search_query %}
            <a href="{% url 'fabrics:fabric_create' %}" class="btn btn-primary mt-3">
                <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —Ç–∫–∞–Ω—å
            </a>
        {% endif %}
    </div>
{% endif %}

<script>
function toggleRolls(element) {
    const preview = element.parentNode.querySelector('.rolls-preview');
    const full = element.parentNode.querySelector('.rolls-full');
    
    if (full.style.display === 'none') {
        preview.style.display = 'none';
        full.style.display = 'inline';
        element.textContent = '—Å–∫—Ä—ã—Ç—å';
    } else {
        preview.style.display = 'inline';
        full.style.display = 'none';
        element.textContent = '–ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ';
    }
}

function confirmDeleteFabric(button) {
    const fabricId = button.dataset.fabricId;
    const fabricName = button.dataset.fabricName;
    const dealsCount = parseInt(button.dataset.dealsCount);
    const colorsCount = parseInt(button.dataset.colorsCount);
    
    let message = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–∫–∞–Ω—å "${fabricName}"?\n\n`;
    
    if (dealsCount > 0) {
        message += `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–∞ —Ç–∫–∞–Ω—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ${dealsCount} —Å–¥–µ–ª–∫–∞—Ö!\n`;
    }
    
    if (colorsCount > 0) {
        message += `üé® –¶–≤–µ—Ç–æ–≤ —Ç–∫–∞–Ω–∏: ${colorsCount}\n`;
    }
    
    message += `\n–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–∫–∞–Ω–∏:\n`;
    message += `‚Ä¢ –í—Å–µ —Ü–≤–µ—Ç–∞ —ç—Ç–æ–π —Ç–∫–∞–Ω–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã\n`;
    message += `‚Ä¢ –í—Å–µ —Ä—É–ª–æ–Ω—ã —ç—Ç–æ–π —Ç–∫–∞–Ω–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã\n`;
    
    if (dealsCount > 0) {
        message += `‚Ä¢ –ü–æ–∑–∏—Ü–∏–∏ –≤ ${dealsCount} —Å–¥–µ–ª–∫–∞—Ö –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã\n`;
    }
    
    message += `\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`;
    
    if (confirm(message)) {
        // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ POST –∑–∞–ø—Ä–æ—Å–∞
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/fabrics/${fabricId}/delete/`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}

