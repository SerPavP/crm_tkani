{% extends 'base.html' %}
{% load deal_filters %}

{% block title %}{{ fabric.name }} - CRM –¢–∫–∞–Ω–∏{% endblock %}

{% block content %}
{% csrf_token %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'fabrics:fabric_list' %}">–¢–∫–∞–Ω–∏</a></li>
                <li class="breadcrumb-item active">{{ fabric.name }}</li>
            </ol>
        </nav>
        <h1><i class="bi bi-palette"></i> {{ fabric.name }}</h1>
        {% if user.userprofile.role == 'admin' %}
            <p class="text-muted">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: {{ fabric.cost_price|format_price }} ‚Ç∏</p>
        {% endif %}
    </div>
    
    {% if user.userprofile.can_manage_fabrics %}
        <div>
            <a href="{% url 'fabrics:color_create' fabric.id %}" class="btn btn-success me-2">
                <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å —Ü–≤–µ—Ç
            </a>
            <a href="{% url 'fabrics:fabric_edit' fabric.id %}" class="btn btn-primary me-2">
                <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </a>
            <button class="btn btn-danger" 
                    data-fabric-id="{{ fabric.id }}"
                    data-fabric-name="{{ fabric.name|escapejs }}"
                    data-deals-count="{{ fabric.deals_count }}"
                    data-colors-count="{{ fabric.fabriccolor_set.count }}"
                    onclick="confirmDeleteFabric(this)">
                <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å —Ç–∫–∞–Ω—å
            </button>
        </div>
    {% endif %}
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">{{ fabric.total_width_meters_formatted }}</h5>
                <p class="card-text text-muted">–í—Å–µ–≥–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</p>
            </div>
        </div>
    </div>
    {% if user.userprofile.role == 'admin' %}
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">{{ fabric.cost_price|format_price }} ‚Ç∏</h5>
                    <p class="card-text text-muted">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">{{ fabric.selling_price|format_price }} ‚Ç∏</h5>
                    <p class="card-text text-muted">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</p>
                </div>
            </div>
        </div>
    {% else %}
        <div class="col-md-6">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">{{ colors|length }}</h5>
                    <p class="card-text text-muted">–¶–≤–µ—Ç–æ–≤ –≤ –Ω–∞–ª–∏—á–∏–∏</p>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- –¶–≤–µ—Ç–∞ —Ç–∫–∞–Ω–∏ -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-palette-fill"></i> –¶–≤–µ—Ç–∞</h5>
    </div>
    <div class="card-body">
        {% if colors %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>–¶–≤–µ—Ç</th>
                            <th>–†—É–ª–æ–Ω—ã –Ω–∞ —Å–∫–ª–∞–¥–µ</th>
                            <th>–í—Å–µ–≥–æ –º–µ—Ç—Ä–æ–≤</th>
                            {% if user.userprofile.role == 'admin' %}
                                <th>–°—É–º–º–∞ –∑–∞ –≤—Å–µ —Ä—É–ª–æ–Ω—ã</th>
                            {% endif %}
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for color in colors %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="color-cube me-2" 
                                             style="width: 30px; height: 30px; background-color: {{ color.color_hex }}; border: 1px solid #ccc; border-radius: 5px;">
                                        </div>
                                        <div>
                                            <strong>{{ color.color_name }}</strong>
                                            <div class="small text-muted">‚Ññ{{ color.color_number }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% with rolls=color.active_rolls_simple %}
                                        {% if rolls %}
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-success me-2">{{ rolls|length }}</span>
                                                <div class="rolls-container" style="max-width: 300px;">
                                                    {% for roll in rolls %}
                                                        <span class="badge bg-light text-dark me-1 mb-1">{{ roll }}</span>
                                                        {% if forloop.counter|divisibleby:12 and not forloop.last %}
                                                            <br>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="badge bg-danger">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    <strong>{{ color.total_width_meters_formatted }}</strong>
                                </td>
                                {% if user.userprofile.role == 'admin' %}
                                    <td>
                                        <strong>{{ color.total_value|format_price }} ‚Ç∏</strong>
                                        <div class="small text-muted">
                                            {{ color.total_width_meters_formatted }} √ó {{ color.fabric.cost_price|format_price }} ‚Ç∏/–º
                                        </div>
                                    </td>
                                {% endif %}
                                    <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'warehouse:create_barcode' %}?fabric_id={{ fabric.id }}&color_id={{ color.id }}" 
                                           class="btn btn-sm btn-outline-success" 
                                           title="–°–æ–∑–¥–∞—Ç—å —à—Ç—Ä–∏—Ö-–∫–æ–¥ –¥–ª—è —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞">
                                            <i class="bi bi-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å —à—Ç—Ä–∏—Ö-–∫–æ–¥
                                        </a>
                                        {% if user.userprofile.can_manage_fabrics %}
                                        <a href="{% url 'fabrics:color_edit' color.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                data-color-id="{{ color.id }}"
                                                data-color-name="{{ color.color_name|escapejs }}"
                                                data-color-number="{{ color.color_number }}"
                                                data-rolls-count="{{ color.active_rolls_simple|length }}"
                                                onclick="confirmDeleteColor(this)">
                                            <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                        {% endif %}
                                    </div>
                                    </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-4">
                <i class="bi bi-palette display-4 text-muted"></i>
                <h5 class="text-muted mt-3">–¶–≤–µ—Ç–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</h5>
                {% if user.userprofile.can_manage_fabrics %}
                    <a href="{% url 'fabrics:color_create' fabric.id %}" class="btn btn-primary mt-3">
                        <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ü–≤–µ—Ç
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<script>
function confirmDeleteFabric(button) {
    const fabricId = button.dataset.fabricId;
    const fabricName = button.dataset.fabricName;
    const dealsCount = parseInt(button.dataset.dealsCount);
    const colorsCount = parseInt(button.dataset.colorsCount);
    
    let message = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–∫–∞–Ω—å "${fabricName}"?\n\n`;
    
    if (dealsCount > 0) {
        message += `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–∞ —Ç–∫–∞–Ω—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ${dealsCount} —Å–¥–µ–ª–∫–∞—Ö!\n`;
    }
    
    if (colorsCount > 0) {
        message += `üé® –¶–≤–µ—Ç–æ–≤ —Ç–∫–∞–Ω–∏: ${colorsCount}\n`;
    }
    
    message += `\n–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–∫–∞–Ω–∏:\n`;
    message += `‚Ä¢ –í—Å–µ —Ü–≤–µ—Ç–∞ —ç—Ç–æ–π —Ç–∫–∞–Ω–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã\n`;
    message += `‚Ä¢ –í—Å–µ —Ä—É–ª–æ–Ω—ã —ç—Ç–æ–π —Ç–∫–∞–Ω–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã\n`;
    
    if (dealsCount > 0) {
        message += `‚Ä¢ –ü–æ–∑–∏—Ü–∏–∏ –≤ ${dealsCount} —Å–¥–µ–ª–∫–∞—Ö –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã\n`;
    }
    
    message += `\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`;
    
    if (confirm(message)) {
        // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ POST –∑–∞–ø—Ä–æ—Å–∞
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/fabrics/${fabricId}/delete/`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function confirmDeleteColor(button) {
    const colorId = button.dataset.colorId;
    const colorName = button.dataset.colorName;
    const colorNumber = button.dataset.colorNumber;
    const rollsCount = parseInt(button.dataset.rollsCount);
    
    let message = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ü–≤–µ—Ç "${colorName}" (‚Ññ${colorNumber})?\n\n`;
    
    if (rollsCount > 0) {
        message += `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –£ —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞ –µ—Å—Ç—å ${rollsCount} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä—É–ª–æ–Ω–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ!\n`;
    }
    
    message += `\n–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ü–≤–µ—Ç–∞:\n`;
    message += `‚Ä¢ –í—Å–µ —Ä—É–ª–æ–Ω—ã —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã\n`;
    if (rollsCount > 0) {
        message += `‚Ä¢ ${rollsCount} —Ä—É–ª–æ–Ω–æ–≤ –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω–æ\n`;
    }
    
    message += `\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`;
    
    if (confirm(message)) {
        // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ POST –∑–∞–ø—Ä–æ—Å–∞
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/fabrics/colors/${colorId}/delete/`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}

